---
title: "Impact of Yield Curves on Equity Sectors"
output: 
  pdf_document: 
    toc: yes
---

```{r setup, include=FALSE}
library(flexdashboard)
suppressPackageStartupMessages(library(tidyverse))
suppressPackageStartupMessages(library(tidyquant))
```

```{r get_data, include=FALSE, cache=TRUE}
source("preprocessing.R")
```

# Introduction and Motivation

For over 30 years, long-run interest rates have been on a slow, steady decline. Now, possibly, they have finally turned a corner. The implications for the American economy are substantial. Whole sectors of the economy have flourished only in a declining rate environment, and there is no empirical evidence of how they will function when long-run rates rise. It has become the received wisdom that asset classes which typically perform well when rates are declining, such as houses, are a safe and low-risk investment, even after the 2008 financial crisis.

The first place to look for the impending sea-change in the rate environment is the yield curve, which shows the current state of market expectations for interest rates over different time periods. Shifts in the yield curve have the most direct impact on the US economy by changing the cost and character of corporate financing.

As different industries rely on a different financing mix, and corporate bond issuance is hardly the only mechanism by which the yield curve can impact US corporations, we will investigate the relationship between changes in the yield curve and different corporate sectors, as defined by Kenneth French of Fama/French Factor Model fame.

We hope to provide a resource to aid in decision-making for portfolio managers, as well as for scenario analyis for corporate decision-makers. 

First, we should examine the raw data.

# Yield Curve

We will characterize the yield curve using nominal, constant maturity bond rate data provided by the (St. Louis Fed)[https://fred.stlouisfed.org/].

It is typical to look at only one or two spreads between time periods to describe the yield curve, with 10Y-2Y spreads being perhaps the most popular. However, the true yield curve is more complex than that.

```{r yc_s, cache=TRUE}
yc %>%#this is faster than moving from long-to-wide, subtracting the column, then moving back
  group_by(duration) %>%
  arrange(date) %>%
  fill() %>%
  ungroup() %>%
  left_join(yc %>%  
              filter(duration==1) %>%
              transmute(date=date,`1`=value),
            by="date") %>%
  mutate(value=value-`1`) %>%
  select(-`1`) %>%
  mutate(duration=ceiling(12*as.numeric(duration))) %>%
  ggplot(aes(x=duration, y=value, group=date)) + 
  geom_line(alpha=0.01) + 
  coord_trans(x="log") +
  scale_x_continuous(breaks=unique(ceiling(12*yc$duration)))+
  scale_y_continuous(labels=scales::percent_format(accuracy=1)) +
  xlab("Months") + ylab("Interest Rate") + theme_light() +
  ggtitle("57 Years of Yield Curves (Spread from 1Y)")
```

We can see that it is highly unusual for the long end of the yield curve to be inverted. It is *not* unusual for the short end of the curve to contain "kinks", in which the 3 or 6 month rates are higher than the 1, 2, or even 5 year rates, before the time-value of money supercedes expectations of future conditions.

We propose to characterize the Yield Curve in any given period as sequence of four spreads. We could use an overall polynomial fit to admit early kinks inside a generally positive-sloping curve, but the coefficients of that fit would not be directly interpretable. By choosing several spreads, we will need to account for collinearity in any predictive regressions.

```{r yc}
yc %>%
  group_by(date) %>%
  mutate(value=value-mean(value, na.rm=T)) %>%
  ungroup() %>%
  mutate(duration=ceiling(12*duration)) %>%
  spread(duration, value) %>% 
  transmute(date=date,
         min=`6` - mean(c(`1`,`3`), na.rm=T),
         early=`12` - `3`,
         mid=`60`-`12`,
         late=mean(c(`120`,`240`,`360`), na.rm=T)-`24`) %>%
  gather(duration, value, -date) %>%
  drop_na() ->
  yc_spreads
yc_spreads %>%
  ggplot(aes(x=date, y=value, col=duration)) +
  geom_line()
```

The first date for which all of these spreads are available is 1982-01-04. We don't want to jettison the late 70's oil crisis, however, as that period represents a substantial portfolio of our body of mid-range negative interest rates. 

## Alternate: Splines

```{r}
yc %>%
  group_by(date) %>%
  arrange(duration) %>%
  mutate(value=c(NA, diff(value))) %>%
  ungroup() ->
  yc_splines
```

# Sector Indexes

Kenneth French has undertaken the Herculean task of assembling economic sector return indexes for US stocks, with data going back to before the Great Depression. We have 49 sectors, which may become unwieldy in the final model. We can use Bayesian shrinkage via multilevel modeling to mitigate the prevalence of Type I errors that would arise from fitting separate regressions for each sector.

First, let's take a look at the cumulative returns of the sectors, starting from 1962, where our Yield Curve data starts.

```{r}
library(plotly)
sector_returns %>%
  group_by(sector) %>%
  arrange(Date) %>%
  replace_na(list(avg_return=0)) %>%
  mutate(cum_return=cumprod(1+avg_return)) %>%
  ungroup() ->
  cum_sr

cum_sr %>%
  ggplot(aes(x=Date,y=cum_return, group=sector)) +
  geom_line(alpha=0.2) + 
  coord_trans(y="log") +
  scale_y_continuous(breaks=c(0,1,1e2,1e4,1e6,1e8)) +
  geom_line(data=filter(cum_sr, sector=="Softw"), col="red") +
  theme_light() +
  ggtitle("Cumulative Performance by Sector (log scale)") + xlab("") + ylab("")
```

A rising tide lifts all boats, apparently. The long-term view also serves to emphasize the importance of starting points. The red-lined sector, the worst performer for nearly the entire history shown, is Software. We started the cumulative series shortly before the late 60's tech bubble collapsed, and an investment of $1 has yet to recover in spite of two subsequent tech bubbles.

Are some sectors more related than others? Let's look at the first two principal components.

```{r sector_pca}
sector_returns %>%
  spread(sector, avg_return) %>%
  drop_na() %>% # we need a contiguous dataset to perform PCA.
  select(-Date) %>% 
  prcomp() %>%
  broom::tidy(matrix="v") %>% 
  filter(PC<3) %>%
  spread(PC, value) %>%
  ggplot(aes(x=`1`, y=`2`)) + 
  geom_text(aes(label=column), angle=45, size=3) + 
  ggtitle("Sector Clustering")
```

It looks like the first principal component is approximately dividing cyclical from non-cyclical sectors, while the second seems roughly to be picking out heavy industry, i.e. mining, commodities, agriculture, and construction, versus services and manufacturing higher up the value chain.

# The Model

We will fit a model of the impact of the state of the yield curve on equity returns. In a world with an efficient market, we might expect equity prices to reflect changes in the yield curve immediately, even though the impact of changes in rates on the cost of capital, or some other relevant effect might be expected to take longer to actually hit the firms' bottom lines. Hence we are comfortable regressing the contemporaneous change in the yield curve against the returns.

TODO: Do we need to smooth?

```{r}
yc_splines %>%
  group_by(duration) %>%
  arrange(date) %>%
  mutate(value=c(NA, diff(value))) %>%
  ggplot(aes(x=value, col=factor(12*duration))) + 
  geom_density() + ggtitle("Daily diff of YC splines")
```

